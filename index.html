<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ãŠè–¬ãƒã‚§ãƒƒã‚«ãƒ¼ æ±ºå®šç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; background: #000; color: white; overflow: hidden; }
        
        /* å·¨å¤§åˆ¤å®šè¡¨ç¤º */
        #banner {
            position: absolute; top: 0; width: 100%; height: 100px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 1.5rem; font-weight: bold; z-index: 100;
            background: rgba(0,0,0,0.8); transition: 0.3s;
        }
        .match { background: #28a745 !important; font-size: 2.2rem !important; }
        .error { background: #dc3545 !important; }
        .wait  { background: #ffc107 !important; color: #000; }

        #container { position: relative; width: 100vw; height: 100vh; }
        video { width: 100%; height: 100%; object-fit: cover; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        /* èª­ã¿å–ã‚Šæ¸ˆã¿ãƒªã‚¹ãƒˆ */
        #log {
            position: absolute; left: 10px; top: 110px;
            background: rgba(0,0,0,0.5); padding: 10px; border-radius: 5px;
            font-size: 0.8rem; pointer-events: none;
        }

        #controls {
            position: absolute; bottom: 30px; width: 100%;
            display: flex; justify-content: space-around; z-index: 110;
        }
        .btn {
            padding: 15px 25px; border-radius: 30px; border: none;
            font-weight: bold; font-size: 1rem; cursor: pointer;
        }
        #clear-btn { background: #6c757d; color: white; }
        #capture-btn { background: white; color: black; }

        #overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 1000;
        }
        #start-btn { padding: 20px 40px; font-size: 1.5rem; border-radius: 50px; background: #007bff; color: white; border: none; }
    </style>
</head>
<body>

    <div id="overlay">
        <button id="start-btn" onclick="startApp()">ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹</button>
    </div>

    <div id="banner">
        <div id="msg">QRã‚’1ã¤ãšã¤æ˜ ã—ã¦ãã ã•ã„</div>
        <div id="sub-msg" style="font-size: 0.9rem; font-weight: normal;">(ãƒã‚±ãƒƒãƒˆ â†’ è¢‹ ã®é †ãªã©)</div>
    </div>

    <div id="log">ã‚¹ã‚­ãƒ£ãƒ³å±¥æ­´: ãªã—</div>
    
    <div id="container">
        <video id="video" playsinline></video>
        <canvas id="canvas"></canvas>
    </div>

    <div id="controls">
        <button id="clear-btn" class="btn" onclick="clearData()">æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™</button>
        <button id="capture-btn" class="btn" onclick="takePhoto()">ğŸ“· æ’®å½±ä¿å­˜</button>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const banner = document.getElementById('banner');
        const msg = document.getElementById('msg');
        const log = document.getElementById('log');
        
        let detectedItems = {}; 
        let audioCtx;
        const HOLD_TIME = 5000; // 5ç§’é–“è¨˜æ†¶ã™ã‚‹

        function playSound(type) {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            if (type === 'scan') {
                osc.frequency.setValueAtTime(1000, now);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(); osc.stop(now + 0.1);
            } else if (type === 'match') {
                [523, 659, 783].forEach((f, i) => {
                    const o = audioCtx.createOscillator();
                    o.connect(audioCtx.destination);
                    o.frequency.setValueAtTime(f, now + i * 0.1);
                    o.start(now + i * 0.1); o.stop(now + i * 0.1 + 0.3);
                });
            } else if (type === 'error') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, now);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                osc.start(); osc.stop(now + 0.5);
            }
        }

        async function startApp() {
            document.getElementById('overlay').style.display = 'none';
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            video.srcObject = stream;
            video.play();
            requestAnimationFrame(tick);
        }

        function tick() {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);

                if (code) {
                    const id = code.data;
                    if (!detectedItems[id] || (Date.now() - detectedItems[id].time > 1000)) {
                        if (!detectedItems[id]) playSound('scan');
                        detectedItems[id] = { time: Date.now(), location: code.location };
                    }
                }
                drawAndCheck();
            }
            requestAnimationFrame(tick);
        }

        function clearData() {
            detectedItems = {};
            banner.className = "";
            msg.innerText = "ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ";
            setTimeout(() => { msg.innerText = "QRã‚’1ã¤ãšã¤æ˜ ã—ã¦ãã ã•ã„"; }, 1000);
        }

        function drawAndCheck() {
            const now = Date.now();
            let activeIds = [];

            for (let id in detectedItems) {
                if (now - detectedItems[id].time > HOLD_TIME) {
                    delete detectedItems[id];
                    continue;
                }
                activeIds.push(id);
                
                // æ ã‚’æã
                const loc = detectedItems[id].location;
                ctx.beginPath();
                ctx.lineWidth = 10;
                ctx.strokeStyle = "#ffc107";
                ctx.moveTo(loc.topLeftCorner.x, loc.topLeftCorner.y);
                ctx.lineTo(loc.topRightCorner.x, loc.topRightCorner.y);
                ctx.lineTo(loc.bottomRightCorner.x, loc.bottomRightCorner.y);
                ctx.lineTo(loc.bottomLeftCorner.x, loc.bottomLeftCorner.y);
                ctx.closePath();
                ctx.stroke();
            }

            log.innerText = "èª­ã¿å–ã‚Šä¸­: " + (activeIds.length > 0 ? activeIds.join(", ") : "ãªã—");

            if (activeIds.length >= 2) {
                // åŒã˜ã‚‚ã®ãŒ2ã¤ã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                if (activeIds.length === 2 && activeIds[0] === activeIds[1]) {
                    if (banner.className !== "match") {
                        playSound('match');
                        banner.className = "match";
                        msg.innerText = "ä¸€è‡´ã—ã¾ã—ãŸï¼";
                        // ä¸€è‡´ã—ãŸã‚‰3ç§’å¾Œã«ã‚¯ãƒªã‚¢
                        setTimeout(clearData, 3000);
                    }
                } else {
                    // é•ã†ã‚‚ã®ãŒ2ã¤ä»¥ä¸Šã‚ã‚‹å ´åˆ
                    if (banner.className !== "error") playSound('error');
                    banner.className = "error";
                    msg.innerText = "ä¸ä¸€è‡´ã§ã™ï¼";
                }
            } else if (activeIds.length === 1) {
                banner.className = "wait";
                msg.innerText = "ã‚‚ã†1ã¤ã‚’ã‚¹ã‚­ãƒ£ãƒ³...";
            } else {
                if (banner.className !== "match") {
                    banner.className = "";
                    msg.innerText = "QRã‚’1ã¤ãšã¤æ˜ ã—ã¦ãã ã•ã„";
                }
            }
        }

        function takePhoto() {
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width; tempCanvas.height = canvas.height;
            const tCtx = tempCanvas.getContext('2d');
            tCtx.drawImage(video, 0, 0);
            tCtx.drawImage(canvas, 0, 0);
            const link = document.createElement('a');
            link.download = `audit_${Date.now()}.png`;
            link.href = tempCanvas.toDataURL();
            link.click();
        }
    </script>
</body>
</html>
