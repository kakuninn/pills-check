<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ãŠè–¬ã‚»ãƒƒãƒˆãƒã‚§ãƒƒã‚«ãƒ¼ Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; background: #000; color: white; overflow: hidden; }
        
        /* å·¨å¤§åˆ¤å®šè¡¨ç¤º */
        #banner {
            position: absolute; top: 0; width: 100%; height: 80px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.8rem; font-weight: bold; z-index: 100;
            background: rgba(0,0,0,0.8); transition: 0.3s;
        }
        .match { background: #28a745 !important; } /* ç·‘ */
        .error { background: #dc3545 !important; } /* èµ¤ */
        .wait  { background: #ffc107 !important; color: #000; } /* é»„ */

        #container { position: relative; width: 100vw; height: 100vh; }
        video { width: 100%; height: 100%; object-fit: cover; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        /* ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ï¼ˆiOSã®éŸ³å†ç”Ÿåˆ¶é™è§£é™¤ç”¨ï¼‰ */
        #overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 1000;
        }
        button {
            padding: 20px 40px; font-size: 1.5rem; border-radius: 50px; border: none;
            background: #007bff; color: white; cursor: pointer;
        }

        #capture-btn {
            position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
            padding: 15px 30px; background: white; color: black;
            border-radius: 30px; font-weight: bold; border: none; z-index: 110;
        }
    </style>
</head>
<body>

    <div id="overlay">
        <h2 style="margin-bottom:20px;">ãŠè–¬ãƒã‚§ãƒƒã‚«ãƒ¼</h2>
        <button onclick="startApp()">ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹</button>
        <p style="margin-top:20px; font-size:0.9rem;">ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã‚«ãƒ¡ãƒ©ã¨éŸ³ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã™</p>
    </div>

    <div id="banner">QRã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„</div>
    
    <div id="container">
        <video id="video" playsinline></video>
        <canvas id="canvas"></canvas>
    </div>

    <button id="capture-btn" onclick="takePhoto()">ğŸ“· ç…§åˆçµæœã‚’ä¿å­˜</button>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const banner = document.getElementById('banner');
        
        let detectedItems = {}; // èª­ã¿å–ã£ãŸQRã‚’ä¸€æ™‚ä¿å­˜ã™ã‚‹å ´æ‰€
        let audioCtx;

        // 1ç‚¹ç›®ï¼š3ã¤ã®éŸ³ãƒ‘ã‚¿ãƒ¼ãƒ³
        function playSound(type) {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            if (type === 'scan') { // èª­ã¿å–ã‚ŠéŸ³ï¼ˆãƒ”ãƒƒï¼‰
                osc.frequency.setValueAtTime(1000, now);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(); osc.stop(now + 0.1);
            } else if (type === 'match') { // ä¸€è‡´éŸ³ï¼ˆã‚­ãƒ©ã‚­ãƒ©ã€œã‚“ï¼‰
                [523, 659, 783, 1046].forEach((f, i) => {
                    const o = audioCtx.createOscillator();
                    const g = audioCtx.createGain();
                    o.connect(g); g.connect(audioCtx.destination);
                    o.frequency.setValueAtTime(f, now + i * 0.1);
                    g.gain.setValueAtTime(0.05, now + i * 0.1);
                    g.gain.exponentialRampToValueAtTime(0.01, now + i * 0.1 + 0.3);
                    o.start(now + i * 0.1); o.stop(now + i * 0.1 + 0.3);
                });
            } else if (type === 'error') { // ä¸ä¸€è‡´éŸ³ï¼ˆãƒ–ãƒ–ãƒ¼ï¼‰
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, now);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                osc.start(); osc.stop(now + 0.5);
            }
        }

        async function startApp() {
            document.getElementById('overlay').style.display = 'none';
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment" } 
            });
            video.srcObject = stream;
            video.play();
            requestAnimationFrame(tick);
        }

        function tick() {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert",
                });

                if (code) {
                    const id = code.data;
                    // æ–°ã—ã„QRã‚’è¦‹ã¤ã‘ãŸã‚‰
                    if (!detectedItems[id]) {
                        playSound('scan');
                    }
                    // èª­ã¿å–ã£ãŸæ™‚é–“ã‚’æ›´æ–°ï¼ˆ2ç§’é–“ä¿æŒï¼‰
                    detectedItems[id] = { time: Date.now(), location: code.location };
                }
                
                drawAndCheck();
            }
            requestAnimationFrame(tick);
        }

        function drawAndCheck() {
            const now = Date.now();
            let idCounts = {};
            let hasError = false;

            // 2ç§’ä»¥ä¸ŠçµŒã£ãŸãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¤ã¤ã€ã‚«ã‚¦ãƒ³ãƒˆ
            for (let id in detectedItems) {
                if (now - detectedItems[id].time > 2000) {
                    delete detectedItems[id];
                    continue;
                }
                idCounts[id] = (idCounts[id] || 0) + 1;
                
                // æ ã®æç”»
                const loc = detectedItems[id].location;
                ctx.beginPath();
                ctx.moveTo(loc.topLeftCorner.x, loc.topLeftCorner.y);
                ctx.lineTo(loc.topRightCorner.x, loc.topRightCorner.y);
                ctx.lineTo(loc.bottomRightCorner.x, loc.bottomRightCorner.y);
                ctx.lineTo(loc.bottomLeftCorner.x, loc.bottomLeftCorner.y);
                ctx.closePath();
                ctx.lineWidth = 10;
                ctx.strokeStyle = "#ffc107"; // åŸºæœ¬ã¯é»„è‰²
                ctx.stroke();
            }

            // åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
            const ids = Object.keys(idCounts);
            if (ids.length === 0) {
                banner.innerText = "QRã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„";
                banner.className = "";
            } else {
                let matchFound = false;
                for (let id in idCounts) {
                    if (idCounts[id] >= 2) matchFound = true;
                }

                if (matchFound) {
                    if (banner.innerText !== "ä¸€è‡´ã—ã¾ã—ãŸï¼") {
                        playSound('match');
                    }
                    banner.innerText = "ä¸€è‡´ã—ã¾ã—ãŸï¼";
                    banner.className = "match";
                } else if (ids.length >= 2) {
                    // 2ç¨®é¡ä»¥ä¸Šã®ç•°ãªã‚‹IDãŒæ˜ ã£ã¦ã„ã‚‹å ´åˆ
                    if (banner.className !== "error") playSound('error');
                    banner.innerText = "ä¸ä¸€è‡´ã§ã™ï¼å†…å®¹ã‚’ç¢ºèªï¼";
                    banner.className = "error";
                } else {
                    banner.innerText = "ãƒšã‚¢ã‚’æ¢ã—ã¦ã„ã¾ã™...";
                    banner.className = "wait";
                }
            }
        }

        function takePhoto() {
            const link = document.createElement('a');
            link.download = `audit_${Date.now()}.png`;
            link.href = canvas.toDataURL();
            link.click();
        }
    </script>
</body>
</html>
