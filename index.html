<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ãŠè–¬ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ»ãƒãƒ«ãƒãƒã‚§ãƒƒã‚«ãƒ¼</title>
    <style>
        body { font-family: sans-serif; margin: 0; overflow: hidden; background: #000; color: white; }
        
        /* 1ç‚¹ç›®ãƒ»2ç‚¹ç›®ï¼šå·¨å¤§ãªåˆ¤å®šè¡¨ç¤º */
        #status-banner {
            position: absolute; top: 0; width: 100%; padding: 20px 0;
            text-align: center; font-size: 2.5rem; font-weight: bold;
            z-index: 100; background: rgba(0,0,0,0.7); transition: 0.3s;
        }
        .mode-ok { background: #28a745 !important; color: white; }
        .mode-ng { background: #dc3545 !important; color: white; }
        .mode-wait { background: #ffc107 !important; color: black; }

        #container { position: relative; width: 100vw; height: 100vh; }
        video { width: 100%; height: 100%; object-fit: cover; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        /* æ’®å½±ãƒœã‚¿ãƒ³ */
        #capture-btn {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            padding: 15px 30px; border-radius: 50px; border: none;
            background: #fff; color: #000; font-size: 1.2rem; font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); z-index: 100;
        }
    </style>
</head>
<body>

    <div id="status-banner">QRã‚³ãƒ¼ãƒ‰ã‚’ã‹ã–ã—ã¦ãã ã•ã„</div>
    
    <div id="container">
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas"></canvas>
    </div>

    <button id="capture-btn">ğŸ“· ç…§åˆçµæœã‚’æ’®å½±</button>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const banner = document.getElementById('status-banner');
        const btn = document.getElementById('capture-btn');

        let detector;
        let lastCodes = [];
        let isSuccessActive = false;

        // 1ç‚¹ç›®ï¼š3ãƒ‘ã‚¿ãƒ¼ãƒ³ã®éŸ³
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playSound(type) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            if (type === 'scan') { // èª­ã¿å–ã‚ŠéŸ³ï¼ˆçŸ­ããƒ”ã‚³ãƒƒï¼‰
                osc.frequency.setValueAtTime(1000, now);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(); osc.stop(now + 0.1);
            } else if (type === 'match') { // ä¸€è‡´éŸ³ï¼ˆã‚¿ãƒ©ãƒ©ãƒ¼ãƒ³ï¼ï¼‰
                [523.25, 659.25, 783.99].forEach((f, i) => {
                    const o = audioCtx.createOscillator();
                    o.connect(gain);
                    o.frequency.setValueAtTime(f, now + i * 0.1);
                    o.start(now + i * 0.1); o.stop(now + i * 0.1 + 0.2);
                });
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
            } else if (type === 'error') { // ä¸ä¸€è‡´éŸ³ï¼ˆãƒ–ãƒ–ãƒ¼ï¼‰
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, now);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                osc.start(); osc.stop(now + 0.5);
            }
        }

        // ã‚«ãƒ¡ãƒ©èµ·å‹•
        async function startCamera() {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment", focusMode: "continuous" } 
            });
            video.srcObject = stream;
            
            // æœ€æ–°ã®BarcodeDetectorãŒä½¿ãˆã‚‹ã‹ç¢ºèª
            if ('BarcodeDetector' in window) {
                detector = new BarcodeDetector({ formats: ['qr_code'] });
                render();
            } else {
                alert("ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ãƒãƒ«ãƒã‚¹ã‚­ãƒ£ãƒ³ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚æœ€æ–°ã®iOSã«ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã—ã¦ãã ã•ã„ã€‚");
            }
        }

        function render() {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // QRã‚³ãƒ¼ãƒ‰ã®æ¤œå‡º
            detector.detect(video).then(codes => {
                processCodes(codes);
            });

            requestAnimationFrame(render);
        }

        function processCodes(codes) {
            if (codes.length === 0) return;

            // ã‚¹ã‚­ãƒ£ãƒ³ã—ãŸIDã‚’ã‚«ã‚¦ãƒ³ãƒˆ
            const counts = {};
            codes.forEach(c => {
                counts[c.rawValue] = (counts[c.rawValue] || 0) + 1;
                // æ–°ã—ã„ã‚³ãƒ¼ãƒ‰ã‚’æ¤œçŸ¥ã—ãŸã‚‰ã‚¹ã‚­ãƒ£ãƒ³éŸ³
                if (!lastCodes.includes(c.rawValue)) playSound('scan');
            });
            lastCodes = codes.map(c => c.rawValue);

            let allMatched = true;
            let anyError = false;

            codes.forEach(code => {
                const isPair = counts[code.rawValue] >= 2;
                
                // æ ã®æç”»
                ctx.lineWidth = 10;
                ctx.strokeStyle = isPair ? '#28a745' : '#ffc107';
                const { x, y, width, height } = code.boundingBox;
                ctx.strokeRect(x, y, width, height);

                // IDã®è¡¨ç¤º
                ctx.fillStyle = isPair ? '#28a745' : '#ffc107';
                ctx.font = "bold 40px sans-serif";
                ctx.fillText(code.rawValue, x, y - 10);

                if (!isPair) allMatched = false;
            });

            // çŠ¶æ…‹åˆ¤å®šã¨å·¨å¤§è¡¨ç¤ºï¼ˆ2ç‚¹ç›®ãƒ»3ç‚¹ç›®ï¼‰
            if (allMatched && codes.length >= 2) {
                if (!isSuccessActive) {
                    banner.innerText = "ã™ã¹ã¦ä¸€è‡´ã—ã¾ã—ãŸï¼";
                    banner.className = "mode-ok";
                    playSound('match');
                    isSuccessActive = true;
                    setTimeout(() => { isSuccessActive = false; }, 3000);
                }
            } else if (codes.length % 2 !== 0) {
                banner.innerText = "ãƒšã‚¢ã‚’æ¢ã—ã¦ã„ã¾ã™...";
                banner.className = "mode-wait";
            } else {
                // ãƒšã‚¢ã«ãªã‚‰ãªã„çµ„ã¿åˆã‚ã›ãŒã‚ã‚‹å ´åˆ
                banner.innerText = "ä¸ä¸€è‡´ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ï¼";
                banner.className = "mode-ng";
                // é »ç¹ã«é³´ã‚Šã™ããªã„ã‚ˆã†èª¿æ•´ãŒå¿…è¦ã§ã™ãŒã€ä¸€æ—¦ã‚¨ãƒ©ãƒ¼éŸ³
                // playSound('error'); 
            }
        }

        // æ’®å½±æ©Ÿèƒ½
        btn.onclick = () => {
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            const tCtx = tempCanvas.getContext('2d');
            tCtx.drawImage(video, 0, 0);
            tCtx.drawImage(canvas, 0, 0);
            
            const link = document.createElement('a');
            link.download = `audit_${new Date().getTime()}.png`;
            link.href = tempCanvas.toDataURL();
            link.click();
        };

        startCamera();
    </script>
</body>
</html>
